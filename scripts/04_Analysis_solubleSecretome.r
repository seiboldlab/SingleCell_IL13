#Load librarieslibrary(DESeq2)library(edgeR)library(heatmap3)library(plotrix)library(Rtsne)library(beeswarm)library(openxlsx)################################## Prep secretome dataset# Read in the datad1<-read.table("IL13SingleCell_FINAL/CodeAndTables/data/Soluble_proteinCounts.txt",header=T,sep="\t",stringsAsFactors=F,quote="")#Filter out all lowly expressed proteins (keep proteins for which there are at least 2 samples with expression of at least 1)d1<-d1[rowSums(d1[,5:ncol(d1)] >= 1) >= 2,]#Get a dataframe version with just Gene_protein as rownames and countssec<-d1sec$Gene_protein[52]<-as.factor("APP_A4_2")rownames(sec)<-sec$Gene_proteinsec<-sec[5:ncol(sec)]#Specify designsubject <- sapply(strsplit(colnames(sec), split ="_"),function(x)x[1])treatment <- sapply(strsplit(colnames(sec), split ="_"),function(x)x[2]) #BSA versus IL13batch <- sapply(strsplit(colnames(sec), split ="_"),function(x)x[3]) #BSA versus IL13status <- sapply(strsplit(colnames(sec), split ="_"),function(x)x[4])  #Asthmatic versus healthydesign <- data.frame(row.names = colnames(sec), subject = as.factor(subject), treatment = treatment,	batch = batch, status = status)#Do VST normalizationdds <- DESeqDataSetFromMatrix(  countData = sec,  colData = design,  design = ~subject + treatment)dds$treatment <- relevel(dds$treatment,"BSA")vst <- varianceStabilizingTransformation(dds)vstMat <- assay(vst)################################## Differential expressiony <- DGEList(counts=sec, group = design$treatment)y <- calcNormFactors(y)design.mat<-model.matrix(~subject + treatment, design)y <- estimateDisp(y, design.mat, robust=TRUE)fit <- glmQLFit(y, design.mat, robust=TRUE)qlf <- glmQLFTest(fit, coef='treatmentIL13')res_edgeR<-topTags(qlf, n=nrow(sec))res_edgeR<-res_edgeR[[1]]#List of genes upregulated by IL13 with FDR < 0.05DEGs_IL13_edgeR_up<-res_edgeR[which(res_edgeR$FDR < 0.05 & res_edgeR$logFC > 0),]DEGs_IL13_edgeR_up<-DEGs_IL13_edgeR_up[order(DEGs_IL13_edgeR_up$logFC,decreasing=T),]#List of genes downregulated by IL13 with FDR < 0.05DEGs_IL13_edgeR_down<-res_edgeR[which(res_edgeR$FDR < 0.05 & res_edgeR$logFC < 0),]DEGs_IL13_edgeR_down<-DEGs_IL13_edgeR_down[order(DEGs_IL13_edgeR_down$logFC,decreasing=F),]################################## Heat map## Collate up and down DEGsDEGs_IL13_edgeR_forHeatmap<-rbind(DEGs_IL13_edgeR_up,DEGs_IL13_edgeR_down)geneOrdering<-c(rownames(DEGs_IL13_edgeR_forHeatmap))#Now make a heatmap y<-DGEList(counts=sec)#Normalize the datay2 <- calcNormFactors(y)#Log CPM the data (non-corrected values)logCPM <- cpm(y2, log=TRUE, prior.count=5)mat<-logCPM[geneOrdering,]rownames(mat)<-sapply(strsplit(rownames(mat),"_"),function(x)x[1])#Get side colors for treatment, batch, and statustreat_cols<-color.scale(as.numeric(as.factor(sapply(strsplit(colnames(mat),"_"),function(x)x[2]))),	extremes=c("grey","black"), color.spec="rgb")status_cols<-color.scale(as.numeric(as.factor(status)),	extremes=c("red","blue"), color.spec="rgb")batch_cols<-color.scale(as.numeric(as.factor(sapply(strsplit(colnames(mat),"_"),function(x)x[3]))),	extremes=c("saddlebrown","grey"), color.spec="rgb")ColSideColors<-data.frame(treat_cols=treat_cols,status_cols=status_cols,batch_cols=batch_cols)mycols = colorRampPalette(c("blue","white","red"))(1000)breakscale = c(-8,seq(-1.8,1.8, length.out=length(mycols)-1), 8)#Col dendrodistance.col = dist(t(mat), method = 'canberra')cluster.col = hclust(distance.col, method = 'ward.D2')#Row dendrodistance.row = as.dist(1 - cor(t(mat), use = "pa"))cluster.row = hclust(distance.row, method = 'complete')pdf('Sec_DEGs_IL13_edgeR_heatmap.pdf',height=6,width=4)#dev.new(height=6,width=5)heatmap3(mat,col=mycols,ColSideColors=as.matrix(ColSideColors),cexRow=0.3, breaks=breakscale,labCol="",	Colv=rev(as.dendrogram(cluster.col)),Rowv=reorder(as.dendrogram(cluster.row),97:1))dev.off()###################### Make box plot for some proteinsmuc<-sec_norm[grep("MUC5AC|MUC2|MUC5B|SCGB1A1",rownames(sec_norm),value=T),]muc_ratio<-muc["MUC5AC_MUC5A",] / muc["MUC5B_MUC5B",]muc<-rbind(muc,muc_ratio)muc_df<-data.frame("norm_exp"=c(muc[1,],muc[2,],muc[3,],muc[5,],muc[4,]),"gene"=c(paste("MUC2",treatment,sep="_"),	paste("MUC5AC",treatment,sep="_"),paste("MUC5B",treatment,sep="_"),paste("MUC5AC/MUC5B",treatment,sep="_"),	paste("SCGB1A1",treatment,sep="_")))color=c("gray","black")testDir<-c("less","less","greater","less","greater")#pdf('Boxplots_GeneComparison_apical.pdf',height=2.5,width=6.5)dev.new(height=3,width=6.5)par(mfrow=c(1,5),bty = "n")count = 1for(i in 1:5){	if(i == 4){		muc_cur<-muc_df[which(muc_df$gene == unique(muc_df$gene)[count:(count + 1)]),][-c(22,24,26),]	}else{		muc_cur<-muc_df[which(muc_df$gene == unique(muc_df$gene)[count:(count + 1)]),]	}	muc_cur$gene<-droplevels(muc_cur$gene)		boxplot(muc_cur$norm_exp~muc_cur$gene,las=1,ylab="normalized protein abundance",col=color,medcol="white",medlwd=1.5,cex=1.5)	mtext(paste("p = ",format(wilcox.test(x=muc_cur$norm_exp[grep("BSA",muc_cur$gene)],y=muc_cur$norm_exp[grep("IL13",muc_cur$gene)],paired=F,		alternative=testDir[i])$p.value,scientific=T,digits=3),sep=""),side=3,line=0.5,at=2.3,adj=1,cex=0.5)#	beeswarm(muc_cur$norm_exp~muc_cur$gene, method="swarm", corral="random",ylab="",xlab="",pch=16,cex=0.7,add=T)	count = count + 2}dev.off()###################### Make additional box plots#First, get size factor normalized datadds_sizeFactors<-estimateSizeFactors(dds)sec_norm<-counts(dds_sizeFactors, normalized=T)muc<-sec_norm[grep("MUC4|MUC16|FCGBP|ITLN1|ITLN2",rownames(sec_norm),value=T),]muc_df<-data.frame("norm_exp"=c(muc[1,],muc[2,],muc[3,],muc[4,],muc[5,]),"gene"=c(paste("FCGBP",treatment,sep="_"),	paste("ITLN1",treatment,sep="_"),paste("ITLN2",treatment,sep="_"),paste("MUC16",treatment,sep="_"),	paste("MUC4",treatment,sep="_")))color=c("gray","black")testDir<-c("less","less","less","greater","greater")#pdf('Boxplots_GeneComparison_up_apical.pdf',height=2.5,width=6.5)dev.new(height=2.5,width=6.5)par(mfrow=c(1,5),bty = "n")count = 1for(i in 1:5){	muc_cur<-muc_df[which(muc_df$gene == unique(muc_df$gene)[count:(count + 1)]),]	muc_cur$gene<-droplevels(muc_cur$gene)		boxplot(muc_cur$norm_exp~muc_cur$gene,las=1,ylab="normalized protein abundance",col=color,medcol="white",medlwd=1.5,cex=1.5)	mtext(paste("p = ",format(wilcox.test(x=muc_cur$norm_exp[grep("BSA",muc_cur$gene)],y=muc_cur$norm_exp[grep("IL13",muc_cur$gene)],paired=F,		alternative=testDir[i])$p.value,scientific=T,digits=3),sep=""),side=3,line=0.5,at=2.3,adj=1,cex=0.5)	count = count + 2}###################### Make additional box plotsmuc<-sec_norm[grep("MUC4|MUC16|SCGB1A1|BPIFA1|LTF",rownames(sec_norm),value=T),]muc_df<-data.frame("norm_exp"=c(muc[1,],muc[2,],muc[3,],muc[4,],muc[5,]),"gene"=c(paste("BPIFA1",treatment,sep="_"),	paste("LTF",treatment,sep="_"),paste("MUC16",treatment,sep="_"),paste("MUC4",treatment,sep="_"),	paste("SCGB1A1",treatment,sep="_")))color=c("gray","black")testDir<-c("greater","greater","greater","greater","greater")#pdf('Boxplots_MoreGeneComparison_down_apical.pdf',height=2.5,width=6.5)dev.new(height=2.5,width=6.5)par(mfrow=c(1,5),bty = "n")count = 1for(i in 1:5){	muc_cur<-muc_df[which(muc_df$gene == unique(muc_df$gene)[count:(count + 1)]),]	muc_cur$gene<-droplevels(muc_cur$gene)		boxplot(muc_cur$norm_exp~muc_cur$gene,las=1,ylab="normalized protein abundance",col=color,medcol="white",medlwd=1.5,cex=1.5)	mtext(paste("p = ",format(wilcox.test(x=muc_cur$norm_exp[grep("BSA",muc_cur$gene)],y=muc_cur$norm_exp[grep("IL13",muc_cur$gene)],paired=F,		alternative=testDir[i])$p.value,scientific=T,digits=3),sep=""),side=3,line=0.5,at=2.3,adj=1,cex=0.5)	count = count + 2}