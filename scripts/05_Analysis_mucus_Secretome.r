#Load librarieslibrary(DESeq2)library(edgeR)library(heatmap3)library(plotrix)library(Rtsne)library(beeswarm)library(openxlsx)################################## Prep secretome dataset# Read in the datad1<-read.table("../data/Mucus_proteinCounts.txt",header=T,sep="\t",stringsAsFactors=F,quote="")#Filter out all lowly expressed proteins (keep proteins for which there are at least 2 samples with expression of at least 1)sec_mucus<-d1[rowSums(d1[,5:ncol(d1)] >= 1) >= 2,]#Finally, get dataframe versions with just Gene_protein as rownames and countsrownames(sec_mucus)<-sec_mucus$Gene_proteinsec_mucus<-sec_mucus[5:ncol(sec_mucus)]#Specify designsubject <- sapply(strsplit(colnames(sec_mucus), split ="_"),function(x)x[1])treatment <- sapply(strsplit(colnames(sec_mucus), split ="_"),function(x)x[2]) #BSA versus IL13batch <- sapply(strsplit(colnames(sec_mucus), split ="_"),function(x)x[3]) #BSA versus IL13status <- sapply(strsplit(colnames(sec_mucus), split ="_"),function(x)x[4])  #Asthmatic versus healthydesign <- data.frame(row.names = colnames(sec_mucus), subject = as.factor(subject), treatment = treatment,	batch = batch, status = status)#Do VST normalizationdds <- DESeqDataSetFromMatrix(  countData = sec_mucus,  colData = design,  design = ~subject + treatment)dds$treatment <- relevel(dds$treatment,"BSA")vst <- varianceStabilizingTransformation(dds)vstMat <- assay(vst)################################## Differential expression#Perform Differential Expressiondesign.mat<-model.matrix(~subject + treatment, design)y <- DGEList(counts=sec_mucus, group = design$treatment)y <- calcNormFactors(y)y <- estimateDisp(y, design.mat, robust=TRUE)fit <- glmQLFit(y, design.mat, robust=TRUE)qlf <- glmQLFTest(fit, coef='treatmentIL13')res_edgeR<-topTags(qlf, n=nrow(sec_mucus))res_edgeR<-res_edgeR[[1]]#List of genes upregulated by IL13 with FDR < 0.05DEGs_IL13_edgeR_up<-res_edgeR[which(res_edgeR$FDR < 0.05 & res_edgeR$logFC > 0),]DEGs_IL13_edgeR_up<-DEGs_IL13_edgeR_up[order(DEGs_IL13_edgeR_up$logFC,decreasing=T),]#List of genes downregulated by IL13 with FDR < 0.05DEGs_IL13_edgeR_down<-res_edgeR[which(res_edgeR$FDR < 0.05 & res_edgeR$logFC < 0),]DEGs_IL13_edgeR_down<-DEGs_IL13_edgeR_down[order(DEGs_IL13_edgeR_down$logFC,decreasing=F),]################################## Heat map####Collate up and down DEGsDEGs_IL13_edgeR_forHeatmap<-rbind(DEGs_IL13_edgeR_down,DEGs_IL13_edgeR_up)#Let's first develop the ordering our gene listsgeneOrdering<-c(rownames(DEGs_IL13_edgeR_forHeatmap))#Now make a heatmap mat<-vstMat[geneOrdering,]rownames(mat)<-sapply(strsplit(rownames(mat),"_"),function(x)x[1])#Get side colors for treatment, batch, and statustreat_cols<-color.scale(as.numeric(as.factor(sapply(strsplit(colnames(mat),"_"),function(x)x[2]))),	extremes=c("blue","red"), color.spec="rgb")status_cols<-color.scale(as.numeric(as.factor(sapply(strsplit(colnames(mat),"_"),function(x)x[4]))),	extremes=c("darkorange","black"), color.spec="rgb")ColSideColors<-data.frame(treat_cols=treat_cols,status_cols=status_cols)mycols = colorRampPalette(c("midnightblue","white","firebrick4"))(1000)breakscale = c(-8,seq(-1.8,1.8, length.out=length(mycols)-1), 8)#Col dendrodistance.col = dist(t(mat), method = 'canberra')cluster.col = hclust(distance.col, method = 'ward.D2')#Row dendro (use the default method, seems to be working much better than canberra)distance.row = as.dist(1 - cor(t(mat), use = "pa"))cluster.row = hclust(distance.row, method = 'complete')pdf('Sec_mucus_DEGs_IL13_edgeR_heatmap.pdf',height=6,width=4)#dev.new(height=6,width=5)heatmap3(mat,col=mycols,ColSideColors=as.matrix(ColSideColors),cexRow=0.3, breaks=breakscale,labCol="",	Colv=as.dendrogram(cluster.col),Rowv=as.dendrogram(cluster.row))dev.off()################################## Box plots#First, get size factor normalized datadds_sizeFactors<-estimateSizeFactors(dds)sec_norm<-counts(dds_sizeFactors, normalized=T)###################### Make box plot comparing occurence of MUC2, MUC5AC, MUC5B, MUC5AC/MUC5B and SCGB1A1muc<-sec_norm[grep("MUC5AC|MUC2|MUC5B|SCGB1A1",rownames(sec_norm),value=T),]muc_ratio<-muc["MUC5AC_MUC5A",] / muc["MUC5B_MUC5B",]muc<-rbind(muc,muc_ratio)muc_df<-data.frame("norm_exp"=c(muc[1,],muc[2,],muc[3,],muc[5,],muc[4,]),"gene"=c(paste("MUC2",treatment,sep="_"),	paste("MUC5AC",treatment,sep="_"),paste("MUC5B",treatment,sep="_"),paste("MUC5AC/MUC5B",treatment,sep="_"),	paste("SCGB1A1",treatment,sep="_")))color=c("gray","black")testDir<-c("less","less","greater","less","greater")pdf('Boxplots_FiveGeneComparison_mucus.pdf',height=2.5,width=6.5)#dev.new(height=2.5,width=6.5)par(mfrow=c(1,5),bty = "n")count = 1for(i in 1:5){	muc_cur<-muc_df[which(muc_df$gene == unique(muc_df$gene)[count:(count + 1)]),]	muc_cur$gene<-droplevels(muc_cur$gene)	boxplot(muc_cur$norm_exp~muc_cur$gene,las=1,ylab="normalized protein abundance",col=color,medcol="white",medlwd=1.5)	mtext(paste("p = ",format(t.test(x=muc_cur$norm_exp[grep("BSA",muc_cur$gene)],y=muc_cur$norm_exp[grep("IL13",muc_cur$gene)],paired=F,		alternative=testDir[i])$p.value,scientific=T,digits=3),sep=""),side=3,line=0.5,at=2.3,adj=1,cex=0.5)	count = count + 2}dev.off()###################### Make additional box plotsmuc<-sec_norm[grep("MUC4|MUC16|FCGBP|ITLN1|ITLN2",rownames(sec_norm),value=T),]muc_df<-data.frame("norm_exp"=c(muc[1,],muc[2,],muc[3,],muc[4,],muc[5,]),"gene"=c(paste("FCGBP",treatment,sep="_"),	paste("ITLN1",treatment,sep="_"),paste("ITLN2",treatment,sep="_"),paste("MUC16",treatment,sep="_"),	paste("MUC4",treatment,sep="_")))color=c("gray","black")testDir<-c("less","less","less","greater","greater")#pdf('Boxplots_FiveMoreGeneComparison_up_mucus.pdf',height=2.5,width=6.5)dev.new(height=2.5,width=6.5)par(mfrow=c(1,5),bty = "n")count = 1for(i in 1:5){	muc_cur<-muc_df[which(muc_df$gene == unique(muc_df$gene)[count:(count + 1)]),]	muc_cur$gene<-droplevels(muc_cur$gene)		boxplot(muc_cur$norm_exp~muc_cur$gene,las=1,ylab="normalized protein abundance",col=color,medcol="white",medlwd=1.5,cex=1.5)	mtext(paste("p = ",format(wilcox.test(x=muc_cur$norm_exp[grep("BSA",muc_cur$gene)],y=muc_cur$norm_exp[grep("IL13",muc_cur$gene)],paired=F,		alternative=testDir[i])$p.value,scientific=T,digits=3),sep=""),side=3,line=0.5,at=2.3,adj=1,cex=0.5)	count = count + 2}###################### Make additional box plotsmuc<-sec_norm[grep("MUC4|MUC16|SCGB1A1|^C3_|^CP_",rownames(sec_norm),value=T),]muc_df<-data.frame("norm_exp"=c(muc[1,],muc[2,],muc[3,],muc[4,],muc[5,]),"gene"=c(paste("C3",treatment,sep="_"),	paste("CP",treatment,sep="_"),paste("MUC16",treatment,sep="_"),paste("MUC4",treatment,sep="_"),	paste("SCGB1A1",treatment,sep="_")))color=c("gray","black")testDir<-c("greater","greater","greater","greater","greater")#pdf('Boxplots_FiveMoreGeneComparison_down_mucus.pdf',height=2.5,width=6.5)dev.new(height=2.5,width=6.5)par(mfrow=c(1,5),bty = "n")count = 1for(i in 1:5){	muc_cur<-muc_df[which(muc_df$gene == unique(muc_df$gene)[count:(count + 1)]),]	muc_cur$gene<-droplevels(muc_cur$gene)		boxplot(muc_cur$norm_exp~muc_cur$gene,las=1,ylab="normalized protein abundance",col=color,medcol="white",medlwd=1.5,cex=1.5)	mtext(paste("p = ",format(wilcox.test(x=muc_cur$norm_exp[grep("BSA",muc_cur$gene)],y=muc_cur$norm_exp[grep("IL13",muc_cur$gene)],paired=F,		alternative=testDir[i])$p.value,scientific=T,digits=3),sep=""),side=3,line=0.5,at=2.3,adj=1,cex=0.5)	count = count + 2}